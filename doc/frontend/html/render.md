# 浏览器内部工作原理

<div id='directory'>

- [前言](#1)
- [渲染引擎](#2)
  - [分类](#2.1)
  - [渲染主流程](#2.2)
- [解析和 `DOM` 树构建](#3)



</div>

<span id='1'></span>
## 前言

主流浏览器：
- `IE`
- `Firefox`
- `Safari`
- `Chrome`
- `Opera`

浏览器的主要功能是将用户选择的网络资源呈现出来，需要从服务器请求资源，然后将其显示在浏览器窗口中。

浏览器的主要构成：
- 用户界面：包括地址栏、后退前进按钮、书签目录等，也就是除了主窗口之外的其他部分
- 浏览器引擎：用来查询和操作渲染引擎的接口
- 渲染引擎：用来显示请求的内容
- 网络：用来完成网络调用
- `UI` 后端：用来绘制类似组合选择框和对话框等基本组件，具有不特定某个平台的通用接口，底层使用操作系统的用户接口
- `JS` 解释器：用来解释执行 `JS` 代码
- 数据存储：属于持久层，轻量级客户端存储技术


<img alt="浏览器的主要组件" src="../../../img/web1.png" style="height:50%;width:50%"/>

<font color='red'>注： `Chrome` 为每个 `Tab` 分配了各自的渲染引擎实例，每一个都是独立的进程 </font>

---

<span id='2'></span>
## 渲染引擎

<span id='2.1'></span>
### 分类

- `Firefox` --- `Geoko`
- `Safari` | `Chrome` --- `webkit`

<span id='2.2'></span>
### 渲染主流程

渲染引擎首先通过网络获得所请求文档的内容，通常以 `8k` 分块的方式完成。

在取得内容之后的基本流程：
1. 解析 `Html` 构建 `DOM` 树：渲染引擎开始解析 `html` 并将标签转化为内容树中的 `DOM` 节点
2. 构建 `render` 树：解析外部 `css` 和 `style` 标签中的样式信息，这些样式信息和 `html` 中的可见性指令将被用来构建 `render` 树，`render` 树由包含颜色和大小等属性的矩形组成，它们将被按照正确的顺序显示到屏幕上
3. 布局 `render` 树：构建好了以后，将会执行布局过程，将确定每个节点在屏幕上的确切坐标
4. 绘制 `render` 树：最后就是绘制，遍历 `render` 树，并使用 `UI` 后端层绘制每一个节点


<img alt="渲染引擎基本流程" src="../../../img/render1.png" style="height:50%;width:50%"/>
 

为了更好的用户体验，渲染引擎将会尽可能早的将内容呈现到屏幕上，并不会等所有 `html` 都解析完成之后再去构建和布局 `render` 树，它是解析一部分内容就显示一部分内容，同时可能还在通过网络下载其余内容。

<img alt="渲染引擎流程" src="../../../img/render2.png" style="height:50%;width:50%"/>

可以看到，尽管 `webkit` 和 `Gecko` 使用的术语稍有不同，但是主要流程基本相同，`Gecko` 称可见的格式化元素组成的树为 `frame` 树，每个元素都是一个 `frame` ，`webkit` 则使用 `render` 树来命名由渲染对象组成的树，`webkit` 中元素的定位称为布局，而 `Gecko` 中称为回流，`webkit` 称利用 `dom` 节点和样式去构建 `render` 树的过程为 `attachment` ，`Gecko` 在 `html` 和 `dom` 树之间附加了一层，称为内容接收器，相当于制造 `dom` 元素的工厂。

---

<span id='3'></span>
## 解析和 `DOM` 树构建

解析是渲染引擎中一个非常重要的过程，这里单独讲一下。

解析一个文档即将其转换为具有一定意义的结构，解析的结果通常是表达文档结构的节点树，称为解析树或者语法树。

例如，解析 `2 + 3 - 1`，可能返回这样一棵树：


<img alt="数学表达式树节点" src="../../../img/render3.png" style="height:50%;width:50%"/>

文法（`Grammars`）：解析基于文档依据的语法规则，每种可被解析的格式必须具有由词汇和语法规则组成的特定的文法，称为上下文无关文法。（人类语言不具有这一特性，因此不能被一般的解析技术所解析）

解析器（`Parser`）解析分为两个子过程：
- 语法分析：就是将输入分解为符号
- 词法分析：对语言应用语法规则

解析器一般先把输入分解为合法的符号，在根据语言的语法规则分析文档结构，从而构建解析树：

<img alt="从源文档到解析树" src="../../../img/render4.png" style="height:50%;width:50%"/>

解析过程是迭代的，解析器取到一个新的符号，用这个符号去匹配一条语法规则，如果匹配了将对应的节点添加到解析树上，然后解析树继续请求下一个符号，如果没有匹配，解析器将在内部保存该符号，然后取下一个符号，直到所有内部保存的符号能够匹配一项语法规则，如果最终没有找到匹配的规则，解析器将抛出一个异常，这意味着文档无效或者包含语法错误。

转换（`Translation`）：很多时候，解析树不是最终结果，解析一般在转换中使用，例如编译过程就是先将源码解析为解析树然后将解析树转换为机器码文档：

<img alt="编译流程" src="../../../img/render5.png" style="height:50%;width:50%"/>

[待补充](http://www.cnblogs.com/rainy-shurun/p/5603686.html)