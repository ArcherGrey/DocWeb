# javascript 作用域、执行上下文、作用域链等相关内容

##  执行上下文 ~~执行环境~~ （execution context）

当 JavaScript 代码执行一段可执行代码(`executable code, EC`)时，会创建对应的执行上下文

可执行代码：
- 全局代码
- 函数代码
- `eval` 代码

通过创建了执行上下文栈（`Execution context stack，ECS`）来管理执行上下文

执行上下文有三个重要属性：
- 变量对象（`Variable object，VO`）
- 作用域链（`Scope chain`）
- `this`

执行上下文会分成两个阶段来处理：
- 进入执行上下文 （分析）
- 执行

## 变量对象

变量对象是和执行上下文相关的数据作用域，存储了上下文中定义的变量和函数声明

### 全局上下文 ~~全局对象~~

全局对象是预定义的对象，作为 `JavaScript` 的全局函数和全局属性的占位符。通过使用全局对象，可以访问所有其他所有预定义的对象、函数和属性。

在顶层 `JavaScript` 代码中，可以用关键字 `this` 引用全局对象。因为全局对象是作用域链的头，这意味着所有非限定性的变量和函数名都会作为该对象的属性来查询。


## 词法作用域 (`scope`)

作用域是指程序源代码中定义变量的区域。

作用域规定了如何查找变量，也就是确定当前执行代码对变量的访问权限。

`JavaScript` 采用词法作用域(`lexical scoping`)，也就是静态作用域，函数的作用域在函数定义的时候就决定了。


### 全局作用域和全局变量

如果变量定义在函数之外，则变量就处于全局作用域中：
```
// 默认全局作用域
var a = 1;
function fn(){};
```
全局作用域中的变量可以在任何其他作用域中访问和修改：
```
var a = 1;
function fn(){
    console.log(a); // 显示 a
    a = 2; // 修改 a 
}
```

全局变量的声明有三种方式：
- 不带 `var` 无论是在哪里，甚至是在函数内部声明，都会隐式声明成全局变量
- 带 `var` 在函数外部声明，这种是显式声明
- 使用 `window` 全局对象来声明，全局对象的属性对应也是全局变量

全局变量的优点：
可以减少变量个数，减少由于实参和形参的数据传递带来的时间消耗

全局变量的缺点：
- 全局变量保存在静态存储区，程序开始运行时为其分配内存，程序结束释放内存，和局部变量的动态分配、动态释放相比，生存期比较长，过多的全局变量会占用较多的内存单元
- 全局变量破坏了函数的封装性能，使得函数对全局变量产生依赖，同时降低了函数的可移植性
- 全局变量使得函数的可读性降低，由于多个函数可能使用相同的全局变量，对于程序的查错和调试都非常不利

注：尽可能少的使用全局变量

### 局部作用域
`javascript` 和 `C++` 之类的语言不同，它的局部作用域是以函数为单位，而不是块级作用域。（注：最新的标准提供了块级作用域）

每个函数被调用的时候都具有不同的作用域，意味着相同名称的变量可以在不同的函数中使用，这是因为它们都是属于不同的作用域，在其他函数中不可被访问。


### 块级作用域

块级声明包括：
- `if`
- `switch`
- `for`
- `while`

`es6` 中引入了 `let` 和 `const` ，这些关键字支持在块级声明中创建使用局部作用域。

### 生存周期

全局作用域的生存周期和应用相同，局部作用域只在函数调用执行期间存在。

## 作用域链

当查找变量的时候，会先从当前上下文的变量对象中查找，如果没有找到，就会从父级（**词法层面上的父级**）执行上下文的变量对象中查找，一直找到全局上下文的变量对象，也就是全局对象。这样由多个执行上下文的变量对象构成的链表就叫做作用域链。

在函数定义的时候创建（作用域在定义的时候决定所以作用域链也是）

作用域链包含变量对象，作用域链用于解析变量，当解析一个变量时，开始从最内层沿着父级寻找所需的变量或者其他资源,作用域链包含自己执行环境以及父级环境中包含的变量对象

内层函数（必须是函数声明）可以访问父级作用域的变量等资源。意味着子函数词法绑定到了父级执行环境。

- 子执行环境可以访问父级变量，反之不行
- 在不同执行环境中同名变量优先级在执行


## 上下文

上下文指的是在作用域中 `this` 所指向的对象：
- 全局作用域中，上下文总是 `window` 对象
- 如果作用域定义在一个对象的方法中，上下文就是这个方法所在的那个对象
- 如果使用 `new` 调用函数时，上下文会被设置为调用函数的实例

在使用严格模式下的全局作用域中调用函数时，上下文默认是 `undefined`，因为严格模式禁止 `this` 指向全局对象。


