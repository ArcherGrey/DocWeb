# 三次握手

建立`TCP`连接时需要客户端和服务器总共发送三个包，目的是连接服务器指定端口，建立连接同步双方序列号和确认号并交换窗口大小信息。

![](https://user-gold-cdn.xitu.io/2019/10/15/16dcfffa2645f3f4?w=756&h=494&f=png&s=179062)

| 缩写 |     中文     |
| :--: | :----------: |
| seq  |     序号     |
| SYN  | 同步序列编号 |
| ACK  |   确认字符   |

1. 建立连接时，客户端发送序号为 `x` 的 `SYN`包到服务器，并进入 `SYN_SENT` 状态，等待服务器确认。
2. 服务器接收到客户端发送过来的 `SYN` ，回复一个 `ACK` 确认号接着客户端的加 1，同时自己也发送一个序号为 `y` 的 `SYN` 到客户端，服务端进入 `SYN_RECV` 状态。
3. 客户端收到服务器发送的 `ACK` 和 `SYN`，回复一个 `ACK` 确认号接着服务器发过来的 `SYN` 序号加一。

发送完毕，客户端和服务器进入 `ESTABLISHED` 状态，连接成功开始传送数据。

# 四次挥手

由于 `TCP` 连接是全双工的，因此每个方向都必须单独进行关闭。这原则是当一方完成它的数据发送任务后就能发送一个 `FIN` 来终止这个方向的连接。收到一个 `FIN` 只意味着这一方向上没有数据流动，一个 `TCP` 连接在收到一个 `FIN` 后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。
（客户端和服务器都可以发起，反过来即可）

![](https://user-gold-cdn.xitu.io/2019/10/15/16dd00e3860a2b65?w=877&h=626&f=png&s=232968)

| 缩写 |   中文   |
| :--: | :------: |
| FIN  | 关闭连接 |

1. 客户端发送 `FIN` 序号为 `u`，客户端进入 `FIN-WAIT-1` 状态
2. 服务器接收到回复 `ACK` 确认号为 `u+1`，服务器进入 `CLOSE_WAIT` 状态，如果服务器还有数据传输就会继续传输。
3. 服务器数据传输完毕，发送 `FIN` 序号为 `w`，确认号为 `u+1`，然后进入 `LAST_ACK` 状态等待客户端回复。
4. 客户端收到回复 `ACK` 确认号为 `w+1`。

# 为什么建立连接是三次握手，而关闭连接却是四次挥手呢？

这是因为服务端在 LISTEN 状态下，收到建立连接请求的 SYN 报文后，把 ACK 和 SYN 放在一个报文里发送给客户端。而关闭连接时，当收到对方的 FIN 报文时，仅仅表示对方不再发送数据了但是还能接收数据，己方也未必全部数据都发送给对方了，所以己方可以立即 close，也可以发送一些数据给对方后，再发送 FIN 报文给对方来表示同意现在关闭连接，因此，己方 ACK 和 FIN 一般都会分开发送。
